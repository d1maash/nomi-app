# üîê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Clerk + Supabase

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase

- ‚úÖ **add-transaction.tsx** - —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Supabase —á–µ—Ä–µ–∑ `useTransactions` —Ö—É–∫
- ‚úÖ **budgets.tsx** - —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –±—é–¥–∂–µ—Ç—ã –≤ Supabase —á–µ—Ä–µ–∑ `useBudgets` —Ö—É–∫  
- ‚úÖ **transactions.tsx** - —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Supabase —á–µ—Ä–µ–∑ `useTransactions` —Ö—É–∫

### 2. –í–∫–ª—é—á–µ–Ω RLS (Row Level Security)

- ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ RLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Clerk JWT
- ‚úÖ –í—Å–µ security advisors –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã - –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç

### 3. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Clerk JWT

- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `createSupabaseClientWithClerkToken` –≤ `lib/supabase.ts`
- ‚úÖ `SupabaseProvider` –ø–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –æ—Ç Clerk –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –µ–≥–æ –≤ Supabase
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç `clerk_id` –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Clerk JWT Template (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å JWT template –≤ Clerk Dashboard.

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π Supabase JWT Template

1. –û—Ç–∫—Ä–æ–π [Clerk Dashboard](https://dashboard.clerk.com)
2. –ü–µ—Ä–µ–π–¥–∏ –≤ **Configure ‚Üí JWT Templates**
3. –ù–∞–∂–º–∏ **New Template**
4. –í—ã–±–µ—Ä–∏ **Supabase** –∏–∑ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π Template

–í —à–∞–±–ª–æ–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ claims:

```json
{
  "sub": "{{user.id}}",
  "email": "{{user.primary_email_address}}",
  "role": "authenticated"
}
```

**–í–∞–∂–Ω–æ:** –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
- Template Name: `supabase` (–∏–º–µ–Ω–Ω–æ —ç—Ç–æ –∏–º—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ)
- Token Lifetime: 3600 seconds (1 hour)

### –®–∞–≥ 3: –ü–æ–ª—É—á–∏ Supabase JWT Secret

1. –û—Ç–∫—Ä–æ–π [Supabase Dashboard](https://supabase.com/dashboard)
2. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç ‚Üí **Settings ‚Üí API**
3. –ù–∞–π–¥–∏ **JWT Secret** –∏ —Å–∫–æ–ø–∏—Ä—É–π –µ–≥–æ
4. –í–µ—Ä–Ω–∏—Å—å –≤ Clerk Dashboard ‚Üí JWT Templates ‚Üí —Ç–≤–æ–π Supabase template
5. –í—Å—Ç–∞–≤—å JWT Secret –≤ –ø–æ–ª–µ **Signing Key**

### –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π

1. –ù–∞–∂–º–∏ **Save**
2. –£–±–µ–¥–∏—Å—å, —á—Ç–æ template –∞–∫—Ç–∏–≤–µ–Ω (enabled)

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Clerk, –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
[sync] Data synced successfully
```

–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å RLS:
```
Error: new row violates row-level security policy
```

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ JWT template –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

### 2. –î–æ–±–∞–≤—å —Ç–µ—Å—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

1. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ù–∞–∂–º–∏ "+" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏
4. –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard ‚Üí Table Editor ‚Üí transactions

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `user_id`.

### 3. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π –±—é–¥–∂–µ—Ç

1. –û—Ç–∫—Ä–æ–π –≤–∫–ª–∞–¥–∫—É "–ë—é–¥–∂–µ—Ç—ã"
2. –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å –±—é–¥–∂–µ—Ç"
3. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏
4. –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard ‚Üí Table Editor ‚Üí budgets

–ë—é–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `user_id`.

---

## üîí –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç RLS

Row Level Security (RLS) - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ Supabase, –∫–æ—Ç–æ—Ä—ã–π –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫.

### –ü–æ–ª–∏—Ç–∏–∫–∏ RLS –≤ –ø—Ä–æ–µ–∫—Ç–µ

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–∏–¥–∞:

```sql
-- –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã transactions
CREATE POLICY "Users can view own transactions"
ON transactions FOR SELECT
USING (
  user_id IN (
    SELECT id FROM users 
    WHERE clerk_id = auth.jwt() ->> 'sub'
  )
);
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `auth.jwt() ->> 'sub'` –∏–∑–≤–ª–µ–∫–∞–µ—Ç `clerk_id` –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `users`

### –ü–æ—á–µ–º—É –≤–∞–∂–µ–Ω JWT Template?

–ë–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ JWT template:
- ‚ùå Supabase –Ω–µ —Å–º–æ–∂–µ—Ç –∏–∑–≤–ª–µ—á—å `clerk_id` –∏–∑ —Ç–æ–∫–µ–Ω–∞
- ‚ùå RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±—É–¥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

–° –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º JWT template:
- ‚úÖ Supabase –∑–Ω–∞–µ—Ç, –∫—Ç–æ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "new row violates row-level security policy"

**–ü—Ä–∏—á–∏–Ω–∞:** JWT template –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ JWT template —Å –∏–º–µ–Ω–µ–º `supabase` —Å–æ–∑–¥–∞–Ω –≤ Clerk
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Signing Key —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å JWT Secret –∏–∑ Supabase
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ template –∞–∫—Ç–∏–≤–µ–Ω (enabled)

### –û—à–∏–±–∫–∞: "No Clerk token available"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Clerk.

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω —á–µ—Ä–µ–∑ Clerk
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ `.env`

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ:
1. JWT template –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
2. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã
3. `user_id` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—à–∏–±–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏
2. –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard ‚Üí Database ‚Üí Policies - RLS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å enabled
3. –ü—Ä–æ–≤–µ—Ä—å –≤ Table Editor ‚Üí users - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –õ–∏–±–æ –∏—Ö –Ω–µ—Ç –≤ –ë–î, –ª–∏–±–æ RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard ‚Üí Table Editor ‚Üí transactions
2. –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –µ—Å—Ç—å, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è - –ø—Ä–æ–±–ª–µ–º–∞ —Å RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
3. –ü—Ä–æ–≤–µ—Ä—å JWT template

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ users

–°–≤—è–∑—ã–≤–∞–µ—Ç Clerk –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Supabase:

```
id (uuid) - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –≤ Supabase
clerk_id (text) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Clerk
email (text) - email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### –¢–∞–±–ª–∏—Ü–∞ transactions

```
id (uuid) - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
user_id (uuid) - FK –Ω–∞ users.id
amount (numeric) - —Å—É–º–º–∞
category (text) - –∫–∞—Ç–µ–≥–æ—Ä–∏—è
description (text) - –æ–ø–∏—Å–∞–Ω–∏–µ
date (timestamptz) - –¥–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
type (text) - 'income' –∏–ª–∏ 'expense'
```

### –¢–∞–±–ª–∏—Ü–∞ budgets

```
id (uuid) - ID –±—é–¥–∂–µ—Ç–∞
user_id (uuid) - FK –Ω–∞ users.id
category (text) - –∫–∞—Ç–µ–≥–æ—Ä–∏—è
limit_amount (numeric) - –ª–∏–º–∏—Ç –±—é–¥–∂–µ—Ç–∞
period (text) - 'weekly' –∏–ª–∏ 'monthly'
start_date (timestamptz) - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
end_date (timestamptz) - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JWT template:

1. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. ‚úÖ –í–æ–π–¥–∏ —á–µ—Ä–µ–∑ Clerk
3. ‚úÖ –ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. ‚úÖ –ü–æ–ø—Ä–æ–±—É–π —Å–æ–∑–¥–∞—Ç—å –±—é–¥–∂–µ—Ç
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Supabase

–ï—Å–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –≥–æ—Ç–æ–≤–æ! üéâ

–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã - –ø—Ä–æ–≤–µ—Ä—å —Ä–∞–∑–¥–µ–ª Troubleshooting –≤—ã—à–µ.

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Clerk JWT Templates Docs](https://clerk.com/docs/backend-requests/making/jwt-templates)
- [Supabase RLS Docs](https://supabase.com/docs/guides/auth/row-level-security)
- [Clerk + Supabase Integration](https://clerk.com/docs/integrations/databases/supabase)
- [Supabase Dashboard](https://supabase.com/dashboard)
- [Clerk Dashboard](https://dashboard.clerk.com)

